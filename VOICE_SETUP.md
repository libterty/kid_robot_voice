# 🎤 語音對話設定指南

## 完整的語音對話功能

現在你可以用**麥克風說話**，AI 會用**喇叭回答**！

### 功能特色

- 🎤 **麥克風輸入** - 直接說話提問
- 🔊 **喇叭輸出** - AI 語音回答
- 🤖 **自動識別** - 說完自動處理
- 💬 **對話記憶** - 記住上下文
- ⚡ **即時回應** - 快速流暢

---

## 📦 安裝音訊套件

### Mac M3 Max 安裝步驟

#### 步驟 1: 安裝 PortAudio

```bash
# 使用 Homebrew 安裝
brew install portaudio
```

#### 步驟 2: 安裝 Python 套件

```bash
# 進入專案
cd kid_robot_project
source venv/bin/activate

# 安裝音訊套件
pip install pyaudio
pip install pydub
pip install playsound

# 或重新安裝所有依賴
pip install -r requirements.txt
```

#### 步驟 3: 授予麥克風權限

第一次執行時，Mac 會彈出權限詢問：

1. **系統偏好設定** → **隱私權與安全性** → **麥克風**
2. 找到 **Terminal** 或 **iTerm**
3. **勾選** 允許

---

## 🚀 開始使用

### 測試音訊裝置

```bash
# 測試麥克風和喇叭
python scripts/voice_chat.py --test
```

會測試：
- ✅ 列出所有麥克風
- ✅ 錄音測試
- ✅ 語音識別測試

### 啟動語音對話

```bash
python scripts/voice_chat.py
```

---

## 💬 使用流程

### 1. 啟動程式

```bash
python scripts/voice_chat.py
```

### 2. 系統初始化

```
🔧 正在初始化系統...
✅ 使用 Ollama 本地模型: llama3.2:3b
✅ 系統初始化完成！

🎤 語音對話模式
============================================================
🤖 小助手: 你好！我是陪讀小助手。你可以直接用說的問我問題喔！
```

### 3. 開始對話

```
----------------------------------------------------------------------
🎤 請說話...
```

**你說話** → 系統自動識別 → AI 思考 → **喇叭播放回答**

### 4. 對話範例

```
🎤 請說話...
👦 你說: 為什麼天空是藍色的？

🤔 正在思考...
🤖 小助手: 因為太陽光中的藍色光線比較容易被空氣散射...
[喇叭播放語音]

----------------------------------------------------------------------
🎤 請說話...
👦 你說: 那晚霞為什麼是紅色的？

🤔 正在思考...
🤖 小助手: 因為傍晚時太陽光要穿過更多的空氣...
[喇叭播放語音]
```

### 5. 結束對話

說「**退出**」或「**再見**」或按 `Ctrl+C`

---

## 🎛️ 語音指令

| 指令 | 功能 |
|------|------|
| 正常提問 | AI 回答問題 |
| 「退出」「結束」「再見」 | 結束對話 |
| 「重置」 | 清除對話歷史 |
| Ctrl+C | 強制退出 |

---

## 🔧 進階設定

### 調整識別靈敏度

編輯 `src/voice/stt.py`:

```python
# 調整這些參數
self.recognizer.energy_threshold = 4000  # 提高 = 減少背景噪音
self.recognizer.pause_threshold = 1.0    # 停頓多久視為結束
```

### 調整語音速度

編輯 `.env`:

```bash
TTS_SLOW=true  # 慢速朗讀（適合小朋友）
```

### 更換語音語言

編輯 `.env`:

```bash
TTS_LANGUAGE=en     # 英語
TTS_LANGUAGE=zh-CN  # 簡體中文
STT_LANGUAGE=en-US  # 英語識別
```

---

## 🐛 常見問題

### Q1: 麥克風沒有聲音？

**檢查清單：**
1. 確認麥克風已插入（或使用內建麥克風）
2. 系統音量未靜音
3. 檢查權限設定

**測試：**
```bash
# 測試麥克風
python scripts/voice_chat.py --test
```

---

### Q2: 權限被拒絕

**錯誤訊息：**
```
Permission denied: Microphone
```

**解決方法：**
1. **系統偏好設定** → **隱私權與安全性** → **麥克風**
2. 勾選 **Terminal** 或 **iTerm**
3. 重新執行程式

---

### Q3: PyAudio 安裝失敗

**錯誤訊息：**
```
ERROR: Failed building wheel for pyaudio
```

**解決方法：**
```bash
# 先安裝 PortAudio
brew install portaudio

# 指定路徑安裝
pip install --global-option='build_ext' \
    --global-option='-I/opt/homebrew/include' \
    --global-option='-L/opt/homebrew/lib' \
    pyaudio
```

---

### Q4: 識別不準確

**改善方法：**

1. **在安靜環境使用**
2. **說話清晰，不要太快**
3. **距離麥克風 10-30cm**
4. **調整識別參數**（見進階設定）

---

### Q5: 播放沒有聲音

**檢查清單：**
1. 系統音量未靜音
2. 喇叭/耳機已連接
3. 確認音訊檔案已生成（在 `data/audio/` 目錄）

**手動測試播放：**
```bash
# Mac 內建播放器
afplay data/audio/tts_20250129_120000.mp3
```

---

### Q6: 識別超時

**調整超時時間：**

編輯 `scripts/voice_chat.py`:

```python
# 在 listen() 方法中
user_input = self.listen(timeout=30)  # 改成 60 秒
```

---

## 💡 使用技巧

### 1. 清晰發音
- 說話速度適中
- 吐字清楚
- 避免連音

### 2. 環境安靜
- 關閉電視/音樂
- 遠離嘈雜區域
- 避免風扇/冷氣噪音

### 3. 麥克風位置
- 距離 10-30cm 最佳
- 不要太遠或太近
- 避免遮擋麥克風

### 4. 分段提問
- 長問題分成幾句說
- 每句之間停頓一下
- 說「重置」可以重新開始

---

## 🆚 文字 vs 語音對話

| 功能 | 文字對話 | 語音對話 |
|------|---------|---------|
| **速度** | ⚡⚡⚡ 快 | ⚡⚡ 中等 |
| **準確度** | ✅ 100% | ⚠️ ~95% |
| **自然度** | 📝 打字 | 🗣️ 說話 |
| **適用場景** | 安靜測試 | 真實互動 |
| **需要權限** | ❌ 不需要 | ✅ 麥克風 |

**建議：**
- 開發測試 → 使用文字對話（`interactive_chat.py`）
- 實際使用 → 使用語音對話（`voice_chat.py`）

---

## 🎉 完整示範

```bash
# 1. 安裝音訊套件
brew install portaudio
pip install pyaudio

# 2. 測試音訊
python scripts/voice_chat.py --test

# 3. 開始語音對話
python scripts/voice_chat.py

# 4. 說話測試
說: "你好"
聽: "你好！我是陪讀小助手..."

說: "為什麼恐龍會滅絕"
聽: "科學家認為是因為一顆隕石..."

說: "退出"
聽: "再見！期待下次再聊！"
```

享受真正的語音對話體驗！🎤🤖
